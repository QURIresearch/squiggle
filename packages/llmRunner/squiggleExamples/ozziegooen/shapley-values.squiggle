/*
Simple Shapley Value Calculator

Some math from GPT-4 plus this blog post:
https://www.aidancooper.co.uk/how-shapley-values-work/

Inspiration from Nuno Sempere's Shapley Value Calculator
https://shapleyvalue.com/

Exported Functions:

shapleyCalculation2Players(vEmpty, v1, v2, v1and2)
shapleyCalculation3Players(vEmpty, v1, v2, v3, ...) // See definition
shapleyCalculation4Players(vEmpty, v1, v2, v3, ...) // See definition


Code and Calculators:

The code is very explicit, because this was simpler to write. Doing a generic version in Squiggle was messier, and didn't seem very critical. If you really want to use functions with over 4 players on Squiggle, let me know.

We only export one super-calculator, for simplicity. If you want me to export the specific calculators with preset players, please message me.
*/

coalitions2Players = ["()", "(1)", "(2)", "(1,2)"]

// Function to calculate Shapley values
export shapleyCalculation2Players(
  v_0,
  v_1,
  v_2,
  v_1_2 // Calculate marginal contributions
) = // Average marginal contributions for each player
{
  marginal_1 = v_1 - v_0
  marginal_2 = v_2 - v_0
  marginal_1_2_to_1 = v_1_2 - v_2
  marginal_1_2_to_2 = v_1_2 - v_1

  shapley_1 = (marginal_1 + marginal_1_2_to_1) / 2
  shapley_2 = (marginal_2 + marginal_1_2_to_2) / 2

  { player1: shapley_1, player2: shapley_2 }
}

b2 = Calculator(
  shapleyCalculation2Players,
  {
    title: "Shapley Value with 2 Players",
    inputs: coalitions2Players
      -> List.map(
        {|player, i| Input.text({ name: "Value of " + player, default: i })}
      ),
  }
)

coalitions3Players = [
  "()",
  "(1)",
  "(2)",
  "(3)",
  "(1,2)",
  "(1,3)",
  "(2,3)",
  "(1,2,3)",
]

// Function to calculate Shapley values
export shapleyCalculation3Players(
  v_0,
  v_1,
  v_2,
  v_3,
  v_1_2,
  v_1_3,
  v_2_3,
  v_1_2_3 // Calculate marginal contributions
) = // Average marginal contributions for each player
{
  marginal_1 = v_1 - v_0
  marginal_2 = v_2 - v_0
  marginal_3 = v_3 - v_0
  marginal_1_2_to_1 = v_1_2 - v_2
  marginal_1_2_to_2 = v_1_2 - v_1
  marginal_1_3_to_1 = v_1_3 - v_3
  marginal_1_3_to_3 = v_1_3 - v_1
  marginal_2_3_to_2 = v_2_3 - v_3
  marginal_2_3_to_3 = v_2_3 - v_2
  marginal_1_2_3_to_1 = v_1_2_3 - v_2_3
  marginal_1_2_3_to_2 = v_1_2_3 - v_1_3
  marginal_1_2_3_to_3 = v_1_2_3 - v_1_2

  shapley_1 = (marginal_1 + marginal_1_2_3_to_1) / 3 +
    (marginal_1_2_to_1 + marginal_1_3_to_1) / 6
  shapley_2 = (marginal_2 + marginal_1_2_3_to_2) / 3 +
    (marginal_1_2_to_2 + marginal_2_3_to_2) / 6
  shapley_3 = (marginal_3 + marginal_1_2_3_to_3) / 3 +
    (marginal_2_3_to_3 + marginal_1_3_to_3) / 6

  { player1: shapley_1, player2: shapley_2, player3: shapley_3 }
}

b3 = Calculator(
  shapleyCalculation3Players,
  {
    title: "Shapley Value with 3 Players",
    inputs: coalitions3Players
      -> List.map(
        {|player, i| Input.text({ name: "Value of " + player, default: i })}
      ),
  }
)

coalitions4Players = [
  "()",
  "(1)",
  "(2)",
  "(3)",
  "(4)",
  "(1,2)",
  "(1,3)",
  "(1,4)",
  "(2,3)",
  "(2,4)",
  "(3,4)",
  "(1,2,3)",
  "(1,2,4)",
  "(1,3,4)",
  "(2,3,4)",
  "(1,2,3,4)",
]

// Function to calculate Shapley values
export shapleyCalculation4Players(
  v_0,
  v_1,
  v_2,
  v_3,
  v_4,
  v_1_2,
  v_1_3,
  v_1_4,
  v_2_3,
  v_2_4,
  v_3_4,
  v_1_2_3,
  v_1_2_4,
  v_1_3_4,
  v_2_3_4,
  v_1_2_3_4
) = {
  marginal_1 = v_1 - v_0
  marginal_2 = v_2 - v_0
  marginal_3 = v_3 - v_0
  marginal_4 = v_4 - v_0
  marginal_1_2_to_1 = v_1_2 - v_2
  marginal_1_2_to_2 = v_1_2 - v_1
  marginal_1_3_to_1 = v_1_3 - v_3
  marginal_1_3_to_3 = v_1_3 - v_1
  marginal_1_4_to_1 = v_1_4 - v_4
  marginal_1_4_to_4 = v_1_4 - v_1
  marginal_2_3_to_2 = v_2_3 - v_3
  marginal_2_3_to_3 = v_2_3 - v_2
  marginal_2_4_to_2 = v_2_4 - v_4
  marginal_2_4_to_4 = v_2_4 - v_2
  marginal_3_4_to_3 = v_3_4 - v_4
  marginal_3_4_to_4 = v_3_4 - v_3
  marginal_1_2_3_to_1 = v_1_2_3 - v_2_3
  marginal_1_2_3_to_2 = v_1_2_3 - v_1_3
  marginal_1_2_3_to_3 = v_1_2_3 - v_1_2
  marginal_1_2_4_to_1 = v_1_2_4 - v_2_4
  marginal_1_2_4_to_2 = v_1_2_4 - v_1_4
  marginal_1_2_4_to_4 = v_1_2_4 - v_1_2
  marginal_1_3_4_to_1 = v_1_3_4 - v_3_4
  marginal_1_3_4_to_3 = v_1_3_4 - v_1_4
  marginal_1_3_4_to_4 = v_1_3_4 - v_1_3
  marginal_2_3_4_to_2 = v_2_3_4 - v_3_4
  marginal_2_3_4_to_3 = v_2_3_4 - v_2_4
  marginal_2_3_4_to_4 = v_2_3_4 - v_2_3
  marginal_1_2_3_4_to_1 = v_1_2_3_4 - v_2_3_4
  marginal_1_2_3_4_to_2 = v_1_2_3_4 - v_1_3_4
  marginal_1_2_3_4_to_3 = v_1_2_3_4 - v_1_2_4
  marginal_1_2_3_4_to_4 = v_1_2_3_4 - v_1_2_3

  shapley_1 = (marginal_1 + marginal_1_2_3_4_to_1) / 4 +
    (marginal_1_2_to_1 + marginal_1_3_to_1 + marginal_1_4_to_1 +
      marginal_1_2_3_to_1 +
      marginal_1_2_4_to_1 +
      marginal_1_3_4_to_1) /
      12
  shapley_2 = (marginal_2 + marginal_1_2_3_4_to_2) / 4 +
    (marginal_1_2_to_2 + marginal_2_3_to_2 + marginal_2_4_to_2 +
      marginal_1_2_3_to_2 +
      marginal_1_2_4_to_2 +
      marginal_2_3_4_to_2) /
      12
  shapley_3 = (marginal_3 + marginal_1_2_3_4_to_3) / 4 +
    (marginal_1_3_to_3 + marginal_2_3_to_3 + marginal_3_4_to_3 +
      marginal_1_2_3_to_3 +
      marginal_1_3_4_to_3 +
      marginal_2_3_4_to_3) /
      12
  shapley_4 = (marginal_4 + marginal_1_2_3_4_to_4) / 4 +
    (marginal_1_4_to_4 + marginal_2_4_to_4 + marginal_3_4_to_4 +
      marginal_1_2_4_to_4 +
      marginal_1_3_4_to_4 +
      marginal_2_3_4_to_4) /
      12

  {
    player1: shapley_1,
    player2: shapley_2,
    player3: shapley_3,
    player4: shapley_4,
  }
}

b4 = Calculator(
  shapleyCalculation4Players,
  {
    title: "Shapley Value with 4 Players",
    inputs: coalitions4Players
      -> List.map(
        {|player, i| Input.text({ name: "Value of " + player, default: i })}
      ),
  }
)

export calc = Calculator(
  {|e| if e == "2" then b2 else if e == "3" then b3 else b4},
  {
    title: "Shapley Calculator for 2-4 Players",
    description: "Calculates the [Shapley Value](https://en.wikipedia.org/wiki/Shapley_value) for different players. 
### Naming convention:
- () => No players
- (1) => Just the first player
- (1,2) => The value of just the combination of players 1 and 2.

### Sources
Inspiration from [Nuno Sempere's Shapley Value Calculator](https://shapleyvalue.com/).    

Some math from this blog post:
[https://www.aidancooper.co.uk/how-shapley-values-work/](https://www.aidancooper.co.uk/how-shapley-values-work/).

",
    inputs: [
      Input.select(
        { name: "Number of Players", options: ["2", "3", "4"], default: "2" }
      ),
    ],
  }
)
